#!/usr/bin/env lua

if os.getenv("SPOODER_INIT") then
	-- could be something like `sudo -K`
	os.execute(os.getenv("SPOODER_INIT"))
end

local spooder = require 'spooder'
local lumber = require 'lumber'

local log = lumber.new {
	format = require 'lumber.format.term';
	level = lumber.levels.ERROR;
}
spooder.helper.log = log

local params do
	local arrr = require 'arrr'
	local parser = arrr {
		{ "List all tasks", "--tasks", "-T" };
		{ "Load a specific task file", "--taskfile", "-t", "<module> or <script>.lua" };
		{ "Changes the log level", "--log", "-L", "log level" };
	}
	params = parser{...}
end

if params.log then
	log.level = lumber.levels[string.upper(params.log)]
end

do
	local file if params.taskfile then
		file = params.taskfile
	else
		file = 'tasks'
	end
	xpcall(function()
		if file:find("%.lua$") then
			dofile(file)
		else
			require(file)
		end
	end, function(err)
		log:fatal("Failed loading task file: " .. err)
		log:debug(debug.traceback(err))
		os.exit()
	end)
end

if params.tasks then
	print("Listing tasks:")
	for name, task in spooder.tasks() do
		print("â€£ "..name, task.description)
	end
	os.exit(0)
end

if #params == 0 then
	log:fatal("Nothing to run 88w88")
end

xpcall(function()
	for i, name in ipairs(params) do
		spooder.run(name)
	end
end, function(err)
	log:fatal(err)
	log:debug(debug.traceback(err))
end)
